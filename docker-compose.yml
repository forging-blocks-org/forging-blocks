services:
  postgres:
    image: postgres:16
    container_name: shared_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    networks:
      - shared_net
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres-initdb:/docker-entrypoint-initdb.d

  tasker_primitive_obsession:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      ENVIRONMENT: development
      DATABASE_URL: postgresql+asyncpg://postgres:password@postgres:5432/postgres
      SECRET_KEY: supersecretkey
      ACCESS_TOKEN_EXPIRES_IN: 3600
      REFRESH_TOKEN_EXPIRES_IN: 604800
      EXAMPLE: tasker_primitive_obsession # Pass the example name via ENV
    depends_on:
      - postgres
    networks:
      - shared_net
    ports:
      - "8000:8000"
    volumes:
      - .:/app # Mount the entire project root to /app
    working_dir: /app # Set working directory to /app for the entrypoint script
    # Remove the 'command' line here. The ENTRYPOINT in your Dockerfile will now run
    # and use the EXAMPLE env var to start the correct app with --reload.

  tasker_strongly_typed:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      ENVIRONMENT: development
      DATABASE_URL: postgresql+asyncpg://postgres:password@postgres:5432/postgres
      SECRET_KEY: supersecretkey
      ACCESS_TOKEN_EXPIRES_IN: 3600
      REFRESH_TOKEN_EXPIRES_IN: 604800
      EXAMPLE: tasker_strongly_typed # Pass the example name via ENV
    depends_on:
      - postgres
    networks:
      - shared_net
    ports:
      - "8001:8000"
    volumes:
      - .:/app # Mount the entire project root to /app
    working_dir: /app # Set working directory to /app for the entrypoint script
    # Remove the 'command' line here. The ENTRYPOINT in your Dockerfile will now run
    # and use the EXAMPLE env var to start the correct app with --reload.

volumes:
  pgdata:

networks:
  shared_net:
    name: shared_db_net
